if: tag IS present

language: go
install: true

go:
  - 1.16.x

dist: bionic
addons:
  apt:
    source:
      - docker-bionic
    packages:
      - docker
services:
  - docker
env:
  global:
    - PROJECT: tokend
    - IMAGE_NAME: terraform-provider-tokend
script:
  - export IMAGE_TAG=$(test -z $TRAVIS_TAG && echo $TRAVIS_COMMIT || echo $TRAVIS_TAG)
  - docker build -t $PROJECT/$IMAGE_NAME:$IMAGE_TAG .
  - CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -mod vendor -o terraform-provider-tokend-linux -v github.com/tokend/terraform-provider-tokend
  - CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build -mod vendor -o terraform-provider-tokend-darwin -v github.com/tokend/terraform-provider-tokend
  - CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -mod vendor -o terraform-provider-tokend-windows -v github.com/tokend/terraform-provider-tokend
before_deploy:
  - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
deploy:
  - provider: script
    script:
      - docker push $PROJECT/$IMAGE_NAME:$IMAGE_TAG
    on:
      all_branches: true
      tags: true
  - skip_cleanup: true
    provider: releases
    file:
      - terraform-provider-tokend-linux
      - terraform-provider-tokend-darwin
      - terraform-provider-tokend-windows
    on:
      repo: tokend/terraform-provider-tokend
      tags: true
